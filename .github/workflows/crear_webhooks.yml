name: Crear Webhooks
on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Array de repositorios destino (ejemplo: repo1,repo2,repo3)'
        required: true
        type: string
      webhooks:
        description: |
          Array de webhooks a crear (ejemplo: VALIDATE_PUSH_USER,DELETE_IMPORTANT_BRANCH)
          Webhooks soportados:
            - DELETE_IMPORTANT_BRANCH: Valida la eliminación de ramas importantes (main, develop, quality).
            - DELETE_PROTECTION_RULES: Detecta la eliminación de reglas de protección en ramas importantes.
            - REPOSITORY_REMOVED: Monitorea la eliminación de repositorios privados.
            - VALIDATE_PUSH_USER: Valida inconsistencias entre usuario/email Git y GitHub en pushes.
            - GENERATE_PULL_REQUEST: Genera PR automáticamente para pushes en ramas release o develop.
            - VALIDATE_JENKINSFILE_CHANGES: Detecta cambios en archivos protegidos (config/Jenkinsfile).
        required: true
        type: string
jobs:
  crear_webhooks:
    name: Crear webhooks en repositorios
    runs-on: self-hosted
    steps:
      - name: Mostrar inputs recibidos
        run: |
          echo "Repositorios: ${{ github.event.inputs.repositories }}"
          echo "Webhooks: ${{ github.event.inputs.webhooks }}"
      - name: Preparar payload JSON
        id: build_payload
        run: |
          repos=$(echo "${{ github.event.inputs.repositories }}" | sed 's/,/","/g')
          hooks=$(echo "${{ github.event.inputs.webhooks }}" | sed 's/,/","/g')
          echo "{\"repositories\":[\"$repos\"],\"webhooks\":[\"$hooks\"]}" > payload.json
      - name: Llamar API para crear webhooks
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_SECRET: ${{ secrets.WEBHOOKS_API_SECRET }}
        run: |
          echo "Llamando API: $API_BASE_URL/webhooks/generate"
          curl -X POST "$API_BASE_URL/webhooks/generate" \
            -H "Content-Type: application/json" \
            -H "x-api-secret: $API_SECRET" \
            --data-binary @payload.json \
            --silent \
            --show-error \
            --write-out "\nHTTP_STATUS=%{http_code}\n" \
            > api_response.json

      - name: Mostrar respuesta de la API
        run: |
          echo "===== Respuesta de la API ====="
          cat api_response.json
